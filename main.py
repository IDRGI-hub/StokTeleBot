import asyncio
import logging
import aiocron
import json
import ast

from aiogram import Bot, Dispatcher

from config import TOKEN, CHAT_IDS, OUTPUT_FILE
from app.hendlers import router
from Parser.Parser import scrape_data
from Parser.Save_utils import save_stock_history

bot = Bot(TOKEN)
dp = Dispatcher()

async def send_daily_stock():
    logging.info("‚è≥ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö...")

    for chat_id in CHAT_IDS:
        await bot.send_message(chat_id=chat_id, text="‚è≥ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö...", parse_mode="Markdown")
        logging.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Å–±–æ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç {chat_id}")

    results = await scrape_data()

    # üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ JSON-—Ñ–∞–π–ª —Å –¥–∞—Ç–æ–π
    save_stock_history(results)

    with open(OUTPUT_FILE, "r", encoding="utf-8") as f:
        data = json.load(f)

    response = "üìä *–û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:*\n\n"

    for product_key, stock in data.items():
        try:
            product_info = ast.literal_eval(product_key)
            name = product_info.get("name", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")
        except Exception:
            name = str(product_key)

        if isinstance(stock, dict):
            response += f"üîπ *{name}*\n"
            response += f"   üî∏ –ö–æ–ª-–≤–æ —Å–∫–ª–∞–¥–æ–≤: {stock['warehouses']}\n"
            if stock.get("details"):
                for warehouse, qty in stock["details"].items():
                    response += f"   üìç {warehouse}: {qty} —à—Ç.\n"
            response += "\n"
        else:
            response += f"üîπ *{name}* - {stock}\n\n"

    MAX_LENGTH = 4000
    for chat_id in CHAT_IDS:
        for i in range(0, len(response), MAX_LENGTH):
            chunk = response[i:i + MAX_LENGTH]
            await bot.send_message(chat_id=chat_id, text=chunk, parse_mode="Markdown")
        logging.info(f"‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —á–∞—Ç {chat_id}")

async def main():
    logging.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    
    # –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–¥–∞—á–∏ –≤ —Ñ–æ–Ω–µ
    aiocron.crontab("50 23 * * *", func=send_daily_stock),
    dp.include_router(router)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    await dp.start_polling(bot, polling_timeout = 5)

if __name__ == '__main__':
    logging.basicConfig(level=logging.INFO)
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("Bye!")
